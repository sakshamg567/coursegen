This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

<additional_info>

</additional_info>

</file_summary>

<directory_structure>
app/
  api/
    chat/
      route.ts
    inngest/
      route.ts
    lesson/
      [id]/
        route.ts
      retry/
        route.ts
  hooks/
    useChatPersistence.ts
    useUser.ts
  lesson/
    [id]/
      page.tsx
  globals.css
  layout.tsx
  page.tsx
components/
  ui/
    badge.tsx
    button.tsx
    CalculatorUI.tsx
    card.tsx
    checkbox.tsx
    collapsible.tsx
    dropdown-menu.tsx
    input.tsx
    label.tsx
    LessonDisp.tsx
    QuizComponent.tsx
  registry.tsx
inngest/
  client.ts
  functions.ts
lib/
  ai/
    index.ts
    prompt.ts
    tools.ts
  supabase/
    client.ts
    middleware.ts
    server.ts
  types.ts
  utils.ts
.gitignore
components.json
eslint.config.mjs
next.config.ts
package.json
postcss.config.mjs
README.md
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="components/ui/collapsible.tsx">
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  )
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  )
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
</file>

<file path="app/api/inngest/route.ts">
import { serve } from "inngest/next";
import { inngest } from "../../../inngest/client";
import { generateLesson } from "@/inngest/functions";

// Create an API that serves zero functions
export const { GET, POST, PUT } = serve({
  client: inngest,
  functions: [generateLesson],
});
</file>

<file path="app/api/lesson/[id]/route.ts">
import { createClient } from "@/lib/supabase/server";
import { NextRequest, NextResponse } from "next/server";

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;
  const supabase = await createClient();

  // Fetch the lesson from database
  const { data: lesson, error } = await supabase
    .from("lessons")
    .select("compiled_js_url")
    .eq("id", id)
    .single();

  if (error || !lesson?.compiled_js_url) {
    return new NextResponse("Lesson not found", { status: 404 });
  }

  // Fetch the compiled code from storage
  const response = await fetch(lesson.compiled_js_url);

  if (!response.ok) {
    return new NextResponse("Failed to fetch compiled code", { status: 500 });
  }

  let compiled = await response.text();

  // Replace the React import with a CDN version
  compiled = compiled.replace(
    /import\s+React\s+from\s+['"]react['"]/g,
    `import React from 'https://esm.sh/react@18'`,
  );
  compiled = compiled.replace(
    /import\s+{([^}]+)}\s+from\s+['"]react['"]/g,
    `import {$1} from 'https://esm.sh/react@18'`,
  );

  return new NextResponse(compiled, {
    headers: {
      "Content-Type": "application/javascript",
      "Cache-Control": "public, max-age=31536000, immutable",
    },
  });
}
</file>

<file path="app/hooks/useChatPersistence.ts">
const CHAT_STORAGE_KEY = "ai-course-chat-messages";
const CHAT_VERSION = "1"; // Increment this if message structure changes

interface StoredChat {
  version: string;
  messages: any[];
  timestamp: number;
}

export function loadMessagesFromStorage(): any[] {
  if (typeof window === "undefined") return [];

  try {
    const stored = localStorage.getItem(CHAT_STORAGE_KEY);
    if (!stored) return [];

    const parsed: StoredChat = JSON.parse(stored);

    // Check version compatibility
    if (parsed.version !== CHAT_VERSION) {
      console.log("Chat version mismatch, clearing old messages");
      localStorage.removeItem(CHAT_STORAGE_KEY);
      return [];
    }

    // Check if messages are less than 24 hours old
    const hoursSinceLastMessage =
      (Date.now() - parsed.timestamp) / (1000 * 60 * 60);
    if (hoursSinceLastMessage > 24) {
      console.log("Chat messages expired (>24h), clearing");
      localStorage.removeItem(CHAT_STORAGE_KEY);
      return [];
    }

    console.log("Loaded", parsed.messages.length, "messages from localStorage");
    return parsed.messages || [];
  } catch (error) {
    console.error("Failed to load chat messages:", error);
    return [];
  }
}

export function clearChatHistory() {
  localStorage.removeItem(CHAT_STORAGE_KEY);
}
</file>

<file path="app/hooks/useUser.ts">
"use client";
import { useEffect, useState } from "react";
import { v4 } from "uuid";

export const useUser = () => {
  const [userId, setUserId] = useState<string | null>(null);

  useEffect(() => {
    let id = localStorage.getItem("userId");

    if (!id) {
      id = v4();
      localStorage.setItem("userId", id);
    }

    setUserId(id);
  }, []);

  return userId;
};
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Geist } from "next/font/google";
import { ThemeProvider } from "next-themes";
import "./globals.css";

const defaultUrl = process.env.VERCEL_URL
  ? `https://${process.env.VERCEL_URL}`
  : "http://localhost:3000";

export const metadata: Metadata = {
  metadataBase: new URL(defaultUrl),
  title: "Next.js and Supabase Starter Kit",
  description: "The fastest way to build apps with Next.js and Supabase",
};

const geistSans = Geist({
  variable: "--font-geist-sans",
  display: "swap",
  subsets: ["latin"],
});

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={`${geistSans.className} antialiased`}>
        <ThemeProvider
          attribute="class"
          defaultTheme="system"
          enableSystem
          disableTransitionOnChange
        >
          {children}
        </ThemeProvider>
      </body>
    </html>
  );
}
</file>

<file path="components/ui/badge.tsx">
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  );
}

export { Badge, badgeVariants };
</file>

<file path="components/ui/button.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button";
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  },
);
Button.displayName = "Button";

export { Button, buttonVariants };
</file>

<file path="components/ui/card.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className,
    )}
    {...props}
  />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
));
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
));
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
));
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
));
CardFooter.displayName = "CardFooter";

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardDescription,
  CardContent,
};
</file>

<file path="components/ui/checkbox.tsx">
"use client";

import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { Check } from "lucide-react";

import { cn } from "@/lib/utils";

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className,
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
));
Checkbox.displayName = CheckboxPrimitive.Root.displayName;

export { Checkbox };
</file>

<file path="components/ui/dropdown-menu.tsx">
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { Check, ChevronRight, Circle } from "lucide-react";

import { cn } from "@/lib/utils";

const DropdownMenu = DropdownMenuPrimitive.Root;

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;

const DropdownMenuGroup = DropdownMenuPrimitive.Group;

const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuSub = DropdownMenuPrimitive.Sub;

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className,
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className,
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className,
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className,
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className,
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className,
    )}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  );
};
DropdownMenuShortcut.displayName = "DropdownMenuShortcut";

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
</file>

<file path="components/ui/input.tsx">
import * as React from "react";

import { cn } from "@/lib/utils";

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className,
        )}
        ref={ref}
        {...props}
      />
    );
  },
);
Input.displayName = "Input";

export { Input };
</file>

<file path="components/ui/label.tsx">
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { cva, type VariantProps } from "class-variance-authority";

import { cn } from "@/lib/utils";

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",
);

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };
</file>

<file path="components/ui/LessonDisp.tsx">
import { createClient } from "@/lib/supabase/client";
import { useEffect, useState } from "react";

import type { Tables } from "@/lib/types";
import Link from "next/link";
import { ArrowRight, RefreshCw } from "lucide-react";

type Lesson = Tables<"lessons">;

export default function LessonCard({
  lesson,
  lessonId,
  lessonNumber,
}: {
  lesson: any;
  lessonId?: number;
  lessonNumber: number;
}) {
  const [lessonStatus, setLessonStatus] = useState<string | null>(
    lesson.status || "pending",
  );
  const [isReady, setIsReady] = useState(false);
  const [isRetrying, setIsRetrying] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const supabase = createClient();

  useEffect(() => {
    if (!lessonId) return;

    // Fetch initial lesson status
    const fetchLesson = async () => {
      const { data, error } = await supabase
        .from("lessons")
        .select("status, compiled_js_url, error")
        .eq("id", lessonId)
        .single();

      if (data) {
        setLessonStatus(data.status);
        setIsReady(data.status === "completed" && !!data.compiled_js_url);
        setErrorMessage(data.error);
      }
    };

    fetchLesson();

    // Subscribe to realtime updates
    const channel = supabase
      .channel(`lesson-${lessonId}`)
      .on(
        "postgres_changes",
        {
          event: "UPDATE",
          schema: "public",
          table: "lessons",
          filter: `id=eq.${lessonId}`,
        },
        (payload) => {
          const newLesson = payload.new as Lesson;
          setLessonStatus(newLesson.status);
          setIsReady(
            newLesson.status === "completed" && !!newLesson.compiled_js_url,
          );
          setErrorMessage(newLesson.error);
          if (newLesson.status !== "failed") {
            setIsRetrying(false);
          }
        },
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [lessonId, supabase]);

  const handleRetry = async () => {
    if (!lessonId || isRetrying) return;

    setIsRetrying(true);
    try {
      const response = await fetch("/api/lesson/retry", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ lessonId }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to retry lesson");
      }

      console.log("Retry triggered successfully:", data);
    } catch (error) {
      console.error("Error retrying lesson:", error);
      setIsRetrying(false);
      alert(
        error instanceof Error
          ? error.message
          : "Failed to retry lesson generation",
      );
    }
  };

  return (
    <div className="p-3 rounded border border-gray-200 dark:border-gray-700">
      <div className="flex justify-between items-center gap-3">
        <div className="flex-1 min-w-0">
          <div className="font-medium text-gray-900 dark:text-white">
            Lesson {lessonNumber}: {lesson.title}
          </div>
          <div className="text-sm text-gray-600 dark:text-gray-400 mt-1">
            {lesson.objective}
          </div>

          {/* Show error message if failed */}
          {lessonStatus === "failed" && errorMessage && (
            <div className="mt-2 text-xs text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded">
              <strong>Error:</strong> {errorMessage}
            </div>
          )}
        </div>

        {/* Link to lesson when ready */}
        {isReady && lessonId ? (
          <Link
            href={`/lesson/${lessonId}`}
            className="flex-shrink-0 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors flex flex-row items-center"
          >
            View Lesson {<ArrowRight className="scale-75" />}
          </Link>
        ) : (
          <div className="flex items-center gap-2">
            <LessonStatusBadge status={lessonStatus} />
            {lessonStatus === "failed" && lessonId && (
              <button
                onClick={handleRetry}
                disabled={isRetrying}
                className="flex-shrink-0 px-3 py-1.5 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white text-sm font-medium rounded-md transition-colors flex flex-row items-center gap-1"
                title="Retry lesson generation"
              >
                <RefreshCw
                  className={`w-3 h-3 ${isRetrying ? "animate-spin" : ""}`}
                />
                {isRetrying ? "Retrying..." : "Retry"}
              </button>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

function LessonStatusBadge({ status }: { status: string | null }) {
  if (!status || status === "pending") {
    return (
      <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs rounded-full">
        <div className="w-2 h-2 bg-gray-400 rounded-full"></div>
        <span>Pending</span>
      </div>
    );
  }

  if (status === "generating" || status === "processing") {
    return (
      <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs rounded-full">
        <div className="animate-spin rounded-full h-2 w-2 border border-blue-600 border-t-transparent"></div>
        <span>Generating...</span>
      </div>
    );
  }

  if (status === "completed") {
    return (
      <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-xs rounded-full">
        <svg className="w-2 h-2" fill="currentColor" viewBox="0 0 20 20">
          <path
            fillRule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clipRule="evenodd"
          />
        </svg>
        <span>Ready</span>
      </div>
    );
  }

  if (status === "failed") {
    return (
      <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-xs rounded-full">
        <svg className="w-2 h-2" fill="currentColor" viewBox="0 0 20 20">
          <path
            fillRule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clipRule="evenodd"
          />
        </svg>
        <span>Failed</span>
      </div>
    );
  }

  return (
    <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs rounded-full">
      <span>{status}</span>
    </div>
  );
}
</file>

<file path="inngest/client.ts">
import { Inngest } from "inngest";

// Create a client to send and receive events
export const inngest = new Inngest({ id: "my-app" });
</file>

<file path="lib/ai/index.ts">
import { wrapAISDK } from "langsmith/experimental/vercel";
import * as ai from "ai";

const { generateObject, generateText } = wrapAISDK(ai);

export { generateObject, generateText };
</file>

<file path="lib/ai/prompt.ts">
export const __lesson_writer_base_prompt = ({
  title,
  objective,
}: {
  title: string;
  objective: string;
}) => {
  return `Generate a complete, self-contained React component for the following lesson:
  Title: ${title}
  Objective: ${objective}

  CRITICAL REQUIREMENTS:
  1. Generate ONLY the component code, no imports, no exports, no markdown
  2. The component must be named "LessonComponent"
  3. Use Tailwind CSS for styling (it's already available)
  4. Make it interactive and engaging where appropriate
  5. Include proper TypeScript types
  6. The code must be production-ready and error-free
  7. For quizzes: include state management, answer checking, and score tracking
  8. For explanations: use clear sections, examples, and visual hierarchy
  9. For interactive content: add buttons, inputs, and dynamic behavior
  10. Use modern React patterns (hooks, functional components)
  11. MUST have ALL closing tags - validate JSX is complete

  SIMPLE TEMPLATE TO FOLLOW:

  function LessonComponent() {
    const [activeSection, setActiveSection] = React.useState(0);

    return (
      <div className="max-w-4xl mx-auto p-6">
        <h1 className="text-3xl font-bold mb-6">${title}</h1>

        <div className="bg-blue-50 p-6 rounded-lg mb-6">
          <h2 className="text-xl font-semibold mb-3">Introduction</h2>
          <p className="text-gray-700">
            [Brief introduction about the topic]
          </p>
        </div>

        <div className="space-y-4 mb-6">
          <h2 className="text-xl font-semibold">Key Concepts</h2>
          <div className="grid md:grid-cols-2 gap-4">
            <div className="bg-white p-4 rounded-lg border">
              <h3 className="font-semibold mb-2">Concept 1</h3>
              <p className="text-sm text-gray-600">[Explanation]</p>
            </div>
            <div className="bg-white p-4 rounded-lg border">
              <h3 className="font-semibold mb-2">Concept 2</h3>
              <p className="text-sm text-gray-600">[Explanation]</p>
            </div>
          </div>
        </div>

        <div className="bg-green-50 p-6 rounded-lg">
          <h2 className="text-xl font-semibold mb-3">Summary</h2>
          <p className="text-gray-700">[Brief summary]</p>
        </div>
      </div>
    );
  }

  You can use UI components from "shadcn".
  Available components:
  - Box({children, className})
  - Text({children, className})
  - Callout({title, children})
  - AnimatedCard({children, className})
  - Graph({data, xKey, yKey, height})
  - SVGCanvas({width, height, shapes})
  - Calculator({formula, inputs})
  - Quiz({questions})
  - Timeline({steps})
  - CodeBlock({code, language})
  - Math({tex})

  DO NOT WRITE ANY IMPORT STATEMENTS, ASSUME THE COMPONENTS TO BE IMPORTED GLOBALLY, JUST USE THEM NORMALLY

  ## SVG GENERATION RULES

  You have access to a tool:

      generate_svg({ prompt })

  Use this tool to generate **educational SVG diagrams** whenever a diagram would help understanding.

  Examples of when to call 'generate_svg':
  - force arrows, vectors, motion diagrams
  - geometry shapes
  - number lines
  - coordinate grid visualizations
  - free body diagrams
  - projectile motion arcs
  - physics conceptual explanations
  - math relationships or annotated shapes
  - algorithm diagrams or flowcharts

  Do NOT call generate_svg unless the diagram is directly useful.

  ### After the tool returns the SVG:

  You MUST continue generating and embed the returned SVG in your component like this:

      <div dangerouslySetInnerHTML={{ __html: \`\${svg_from_tool}\` }} />

  or wrap it in a component if needed.

  IMPORTANT: After calling any tools, you MUST output the complete LessonComponent function with the tool results incorporated.

  Now generate the component for: ${objective}

  Return ONLY the function code, starting with "function LessonComponent()" and ending with the closing brace.`;
};

export const __lesson_writer_error_prompt = ({
  lastErr,
  generated_code,
}: {
  lastErr: string;
  generated_code: string;
}) => {
  return `The following React TSX component failed to compile or render:

  Error: ${lastErr}

  Broken Code:
  ${generated_code}

  Fix it and output a **working corrected version** of the same component.
  Rules:
  - Keep the same function name (LessonComponent)
  - Return only the function code
  - It must compile and render without error.`;
};
</file>

<file path="lib/supabase/client.ts">
import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
  );
}
</file>

<file path="lib/supabase/middleware.ts">
import { createServerClient } from "@supabase/ssr";
import { NextResponse, type NextRequest } from "next/server";
import { hasEnvVars } from "../utils";

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  });

  // If the env vars are not set, skip middleware check. You can remove this
  // once you setup the project.
  if (!hasEnvVars) {
    return supabaseResponse;
  }

  // With Fluid compute, don't put this client in a global environment
  // variable. Always create a new one on each request.
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value),
          );
          supabaseResponse = NextResponse.next({
            request,
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options),
          );
        },
      },
    },
  );

  // Do not run code between createServerClient and
  // supabase.auth.getClaims(). A simple mistake could make it very hard to debug
  // issues with users being randomly logged out.

  // IMPORTANT: If you remove getClaims() and you use server-side rendering
  // with the Supabase client, your users may be randomly logged out.
  const { data } = await supabase.auth.getClaims();
  const user = data?.claims;

  if (
    request.nextUrl.pathname !== "/" &&
    !user &&
    !request.nextUrl.pathname.startsWith("/login") &&
    !request.nextUrl.pathname.startsWith("/auth")
  ) {
    // no user, potentially respond by redirecting the user to the login page
    const url = request.nextUrl.clone();
    url.pathname = "/auth/login";
    return NextResponse.redirect(url);
  }

  // IMPORTANT: You *must* return the supabaseResponse object as it is.
  // If you're creating a new response object with NextResponse.next() make sure to:
  // 1. Pass the request in it, like so:
  //    const myNewResponse = NextResponse.next({ request })
  // 2. Copy over the cookies, like so:
  //    myNewResponse.cookies.setAll(supabaseResponse.cookies.getAll())
  // 3. Change the myNewResponse object to fit your needs, but avoid changing
  //    the cookies!
  // 4. Finally:
  //    return myNewResponse
  // If this is not done, you may be causing the browser and server to go out
  // of sync and terminate the user's session prematurely!

  return supabaseResponse;
}
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

// This check can be removed, it is just for tutorial purposes
export const hasEnvVars =
  process.env.NEXT_PUBLIC_SUPABASE_URL &&
  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY;
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
</file>

<file path="eslint.config.mjs">
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
];

export default eslintConfig;
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

export default config;
</file>

<file path="README.md">
<a href="https://demo-nextjs-with-supabase.vercel.app/">
  <img alt="Next.js and Supabase Starter Kit - the fastest way to build apps with Next.js and Supabase" src="https://demo-nextjs-with-supabase.vercel.app/opengraph-image.png">
  <h1 align="center">Next.js and Supabase Starter Kit</h1>
</a>

<p align="center">
 The fastest way to build apps with Next.js and Supabase
</p>

<p align="center">
  <a href="#features"><strong>Features</strong></a> 路
  <a href="#demo"><strong>Demo</strong></a> 路
  <a href="#deploy-to-vercel"><strong>Deploy to Vercel</strong></a> 路
  <a href="#clone-and-run-locally"><strong>Clone and run locally</strong></a> 路
  <a href="#feedback-and-issues"><strong>Feedback and issues</strong></a>
  <a href="#more-supabase-examples"><strong>More Examples</strong></a>
</p>
<br/>

## Features

- Works across the entire [Next.js](https://nextjs.org) stack
  - App Router
  - Pages Router
  - Middleware
  - Client
  - Server
  - It just works!
- supabase-ssr. A package to configure Supabase Auth to use cookies
- Password-based authentication block installed via the [Supabase UI Library](https://supabase.com/ui/docs/nextjs/password-based-auth)
- Styling with [Tailwind CSS](https://tailwindcss.com)
- Components with [shadcn/ui](https://ui.shadcn.com/)
- Optional deployment with [Supabase Vercel Integration and Vercel deploy](#deploy-your-own)
  - Environment variables automatically assigned to Vercel project

## Demo

You can view a fully working demo at [demo-nextjs-with-supabase.vercel.app](https://demo-nextjs-with-supabase.vercel.app/).

## Deploy to Vercel

Vercel deployment will guide you through creating a Supabase account and project.

After installation of the Supabase integration, all relevant environment variables will be assigned to the project so the deployment is fully functioning.

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Ftree%2Fcanary%2Fexamples%2Fwith-supabase&project-name=nextjs-with-supabase&repository-name=nextjs-with-supabase&demo-title=nextjs-with-supabase&demo-description=This+starter+configures+Supabase+Auth+to+use+cookies%2C+making+the+user%27s+session+available+throughout+the+entire+Next.js+app+-+Client+Components%2C+Server+Components%2C+Route+Handlers%2C+Server+Actions+and+Middleware.&demo-url=https%3A%2F%2Fdemo-nextjs-with-supabase.vercel.app%2F&external-id=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js%2Ftree%2Fcanary%2Fexamples%2Fwith-supabase&demo-image=https%3A%2F%2Fdemo-nextjs-with-supabase.vercel.app%2Fopengraph-image.png)

The above will also clone the Starter kit to your GitHub, you can clone that locally and develop locally.

If you wish to just develop locally and not deploy to Vercel, [follow the steps below](#clone-and-run-locally).

## Clone and run locally

1. You'll first need a Supabase project which can be made [via the Supabase dashboard](https://database.new)

2. Create a Next.js app using the Supabase Starter template npx command

   ```bash
   npx create-next-app --example with-supabase with-supabase-app
   ```

   ```bash
   yarn create next-app --example with-supabase with-supabase-app
   ```

   ```bash
   pnpm create next-app --example with-supabase with-supabase-app
   ```

3. Use `cd` to change into the app's directory

   ```bash
   cd with-supabase-app
   ```

4. Rename `.env.example` to `.env.local` and update the following:

  ```env
  NEXT_PUBLIC_SUPABASE_URL=[INSERT SUPABASE PROJECT URL]
  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=[INSERT SUPABASE PROJECT API PUBLISHABLE OR ANON KEY]
  ```
  > [!NOTE]
  > This example uses `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`, which refers to Supabase's new **publishable** key format.
  > Both legacy **anon** keys and new **publishable** keys can be used with this variable name during the transition period. Supabase's dashboard may show `NEXT_PUBLIC_SUPABASE_ANON_KEY`; its value can be used in this example.
  > See the [full announcement](https://github.com/orgs/supabase/discussions/29260) for more information.

  Both `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` can be found in [your Supabase project's API settings](https://supabase.com/dashboard/project/_?showConnect=true)

5. You can now run the Next.js local development server:

   ```bash
   npm run dev
   ```

   The starter kit should now be running on [localhost:3000](http://localhost:3000/).

6. This template comes with the default shadcn/ui style initialized. If you instead want other ui.shadcn styles, delete `components.json` and [re-install shadcn/ui](https://ui.shadcn.com/docs/installation/next)

> Check out [the docs for Local Development](https://supabase.com/docs/guides/getting-started/local-development) to also run Supabase locally.

## Feedback and issues

Please file feedback and issues over on the [Supabase GitHub org](https://github.com/supabase/supabase/issues/new/choose).

## More Supabase examples

- [Next.js Subscription Payments Starter](https://github.com/vercel/nextjs-subscription-payments)
- [Cookie-based Auth and the Next.js 13 App Router (free course)](https://youtube.com/playlist?list=PL5S4mPUpp4OtMhpnp93EFSo42iQ40XjbF)
- [Supabase Auth and the Next.js App Router](https://github.com/supabase/supabase/tree/master/examples/auth/nextjs)
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

export default {
  darkMode: ["class"],
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        chart: {
          "1": "hsl(var(--chart-1))",
          "2": "hsl(var(--chart-2))",
          "3": "hsl(var(--chart-3))",
          "4": "hsl(var(--chart-4))",
          "5": "hsl(var(--chart-5))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
} satisfies Config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="app/api/lesson/retry/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { type Database } from "@/lib/types";
import { inngest } from "@/inngest/client";

// Create a Supabase client with service role for server-side operations
function createServiceClient() {
  return createClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    },
  );
}

export async function POST(request: NextRequest) {
  try {
    const { lessonId } = await request.json();

    if (!lessonId) {
      return NextResponse.json(
        { error: "Lesson ID is required" },
        { status: 400 },
      );
    }

    const supabase = createServiceClient();

    // Fetch the lesson details including the previous error
    const { data: lesson, error: fetchError } = await supabase
      .from("lessons")
      .select("*")
      .eq("id", lessonId)
      .single();

    if (fetchError || !lesson) {
      return NextResponse.json({ error: "Lesson not found" }, { status: 404 });
    }

    // Reset the lesson status to pending
    const { error: updateError } = await supabase
      .from("lessons")
      .update({
        status: "pending",
        error: null,
      })
      .eq("id", lessonId);

    if (updateError) {
      throw new Error(`Failed to update lesson: ${updateError.message}`);
    }

    // Trigger the Inngest event with the previous error context
    await inngest.send({
      name: "lesson.generate",
      data: {
        lesson_id: lesson.id,
        title: lesson.title,
        objective: lesson.objective,
        course_id: lesson.course_id,
        previous_error: lesson.error, // Include the previous error
        is_retry: true,
      },
    });

    return NextResponse.json({
      success: true,
      message: "Lesson generation retry triggered",
      lessonId,
    });
  } catch (error) {
    console.error("Error retrying lesson:", error);
    return NextResponse.json(
      {
        error:
          error instanceof Error ? error.message : "Failed to retry lesson",
      },
      { status: 500 },
    );
  }
}
</file>

<file path="app/lesson/[id]/page.tsx">
"use client";

import { use, useEffect, useState } from "react";
import React from "react";
import * as RegistryComponents from "@/components/registry";

const {
  Box,
  Text,
  Callout,
  Calculator,
  AnimatedCard,
  SVGCanvas,
  Math,
  Timeline,
  Quiz,
  CodeBlock,
} = RegistryComponents;

export default function LessonPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const [Comp, setComp] = useState<React.FunctionComponent | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const { id } = use(params);

  useEffect(() => {
    async function load() {
      try {
        // Fetch the compiled code from our API route
        const response = await fetch(`/api/lesson/${id}`);

        if (!response.ok) {
          const contentType = response.headers.get("content-type");
          if (contentType?.includes("application/json")) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || `Failed to fetch: ${response.status}`,
            );
          }
          throw new Error(
            `Failed to fetch: ${response.status} ${response.statusText}`,
          );
        }

        const code = await response.text();

        // Remove the imports since we'll provide React directly
        const codeWithoutImports = code
          .replace(/import\s+React\s+from\s+['"][^'"]+['"];?\s*/g, "")
          .replace(/import\s+{\s*([^}]+)\s*}\s+from\s+['"]react['"];?\s*/g, "")
          .replace(
            /import\s+{\s*([^}]+)\s*}\s+from\s+['"]https:\/\/esm\.sh\/react@\d+['"];?\s*/g,
            "",
          );

        // Wrap the code to inject React and registry components
        const wrappedCode = `
const React = window.__REACT__;
const { useState, useEffect, useCallback, useMemo, useRef } = React;
const { Box, Text, Callout, Calculator, AnimatedCard, SVGCanvas, Math, Timeline, Quiz, CodeBlock, Graph } = window.__REGISTRY__;

${codeWithoutImports}

export default LessonComponent

`;

        // Expose React and registry components globally for the dynamic module
        (window as any).__REACT__ = React;
        (window as any).__REGISTRY__ = RegistryComponents;

        // Create a blob URL from the code
        const blob = new Blob([wrappedCode], {
          type: "application/javascript",
        });
        const url = URL.createObjectURL(blob);

        // Import from the blob URL
        const mod = await import(/* webpackIgnore: true */ url);

        // Clean up
        URL.revokeObjectURL(url);

        // Get the component
        const Component = mod.LessonComponent || mod.default;
        if (!Component) {
          throw new Error(
            "No component found in module exports: " +
              Object.keys(mod).join(", "),
          );
        }

        setComp(() => Component);
      } catch (err) {
        setError(
          err instanceof Error
            ? err.message
            : "Failed to load lesson component",
        );
      } finally {
        setLoading(false);
      }
    }

    load();
  }, [id]);

  if (error) {
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
          <strong className="font-bold">Error: </strong>
          <span className="block sm:inline">{error}</span>
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="p-6 max-w-2xl mx-auto text-center">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-3/4 mx-auto"></div>
          <div className="h-4 bg-gray-200 rounded"></div>
          <div className="h-4 bg-gray-200 rounded w-5/6 mx-auto"></div>
        </div>
        <p className="mt-4 text-gray-600">Loading lesson...</p>
      </div>
    );
  }

  if (!Comp) {
    return (
      <div className="p-6 text-center text-gray-500">
        No component available
      </div>
    );
  }

  return (
    <div>
      <Comp />
    </div>
  );
}
</file>

<file path="app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
    :root {
        --background: 0 0% 100%;
        --foreground: 0 0% 3.9%;
        --card: 0 0% 100%;
        --card-foreground: 0 0% 3.9%;
        --popover: 0 0% 100%;
        --popover-foreground: 0 0% 3.9%;
        --primary: 0 0% 9%;
        --primary-foreground: 0 0% 98%;
        --secondary: 0 0% 96.1%;
        --secondary-foreground: 0 0% 9%;
        --muted: 0 0% 96.1%;
        --muted-foreground: 0 0% 45.1%;
        --accent: 0 0% 96.1%;
        --accent-foreground: 0 0% 9%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 0 0% 98%;
        --border: 0 0% 89.8%;
        --input: 0 0% 89.8%;
        --ring: 0 0% 3.9%;
        --chart-1: 12 76% 61%;
        --chart-2: 173 58% 39%;
        --chart-3: 197 37% 24%;
        --chart-4: 43 74% 66%;
        --chart-5: 27 87% 67%;
        --radius: 0.5rem;
        --border: 0 0% 18%;
    }
    .dark {
        --background: 0 0% 3.9%;
        --foreground: 0 0% 98%;
        --card: 0 0% 3.9%;
        --card-foreground: 0 0% 98%;
        --popover: 0 0% 3.9%;
        --popover-foreground: 0 0% 98%;
        --primary: 0 0% 98%;
        --primary-foreground: 0 0% 9%;
        --secondary: 0 0% 14.9%;
        --secondary-foreground: 0 0% 98%;
        --muted: 0 0% 14.9%;
        --muted-foreground: 0 0% 63.9%;
        --accent: 0 0% 14.9%;
        --accent-foreground: 0 0% 98%;
        --destructive: 0 62.8% 30.6%;
        --destructive-foreground: 0 0% 98%;
        --border: 0 0% 14.9%;
        --input: 0 0% 14.9%;
        --ring: 0 0% 83.1%;
        --chart-1: 220 70% 50%;
        --chart-2: 160 60% 45%;
        --chart-3: 30 80% 55%;
        --chart-4: 280 65% 60%;
        --chart-5: 340 75% 55%;
    }
}

@layer base {
    * {
        @apply border-border;
    }
    body {
        @apply bg-background text-foreground;
    }
}
</file>

<file path="components/ui/CalculatorUI.tsx">
import { useState } from "react";

type CalcInput = {
  name: string;
  label: string;
  type?: string; // "number" etc
};

export const CalculatorUI = ({
  formula,
  inputs,
  onResult,
}: {
  formula: string;
  inputs: CalcInput[];
  onResult?: (result: number) => void;
}) => {
  const [values, setValues] = useState<Record<string, string>>({});

  const compute = () => {
    // still using Function()  your call, but typing is fine
    const fn = new Function(...inputs.map((i) => i.name), `return ${formula};`);

    const args = inputs.map((i) => parseFloat(values[i.name] || "0"));
    const result = fn(...args);
    onResult?.(result);
  };

  return (
    <div className="p-4 border rounded space-y-4 bg-gray-50">
      <h2 className="font-medium">{formula}</h2>

      {inputs.map((input) => (
        <div key={input.name}>
          <label className="block text-sm font-medium">{input.label}</label>
          <input
            type="number"
            className="border p-2 rounded w-full"
            onChange={(e) =>
              setValues((prev) => ({
                ...prev,
                [input.name]: e.target.value,
              }))
            }
          />
        </div>
      ))}

      <button
        onClick={compute}
        className="px-4 py-2 bg-green-600 text-white rounded"
      >
        Compute
      </button>
    </div>
  );
};
</file>

<file path="components/ui/QuizComponent.tsx">
// components/blocks/QuizComponent.tsx
import { useState } from "react";

type QuizQuestion = {
  id: number;
  question: string;
  options: string[];
  correct: string;
};

type QuizComponentProps = {
  questions: QuizQuestion[];
  onComplete?: (score: number) => void;
};

export const QuizComponent = ({
  questions,
  onComplete,
}: QuizComponentProps) => {
  const [answers, setAnswers] = useState<Record<number, string>>({});
  const [submitted, setSubmitted] = useState(false);

  const handleSubmit = () => {
    const score = questions.reduce(
      (acc, q) => (answers[q.id] === q.correct ? acc + 1 : acc),
      0,
    );
    setSubmitted(true);
    onComplete?.(score);
  };

  if (submitted)
    return (
      <div className="p-4 rounded bg-green-50 border border-green-300">
        <h2 className="font-bold mb-2">Quiz Complete!</h2>
        <p>
          Your score:{" "}
          {
            Object.values(answers).filter((a, i) => a === questions[i].correct)
              .length
          }
        </p>
      </div>
    );

  return (
    <div className="space-y-6">
      {questions.map((q) => (
        <div key={q.id} className="p-4 border rounded">
          <h3 className="font-semibold mb-2">
            {q.id}. {q.question}
          </h3>
          {q.options.map((option) => (
            <label key={option} className="block">
              <input
                type="radio"
                name={`q-${q.id}`}
                value={option}
                onChange={() =>
                  setAnswers((prev) => ({ ...prev, [q.id]: option }))
                }
              />
              <span className="ml-2">{option}</span>
            </label>
          ))}
        </div>
      ))}

      <button
        onClick={handleSubmit}
        className="px-4 py-2 bg-blue-600 text-white rounded"
      >
        Submit
      </button>
    </div>
  );
};
</file>

<file path="components/registry.tsx">
import { ReactNode } from "react";
import { motion } from "framer-motion";
import katex from "katex";
import {
  ResponsiveContainer,
  LineChart,
  Line,
  CartesianGrid,
  XAxis,
  YAxis,
} from "recharts";
import { QuizComponent } from "./ui/QuizComponent";
import { CalculatorUI } from "./ui/CalculatorUI";

// Box
export const Box = ({
  children,
  className = "",
}: {
  children: ReactNode;
  className?: string;
}) => <div className={`p-4 rounded-lg ${className}`}>{children}</div>;

// Text
export const Text = ({
  children,
  className = "",
}: {
  children: ReactNode;
  className?: string;
}) => <p className={className}>{children}</p>;

// Callout
export const Callout = ({
  title,
  children,
}: {
  title: string;
  children: ReactNode;
}) => (
  <div className="p-4 rounded-md bg-indigo-50 border-l-4 border-indigo-500">
    <strong className="block mb-1">{title}</strong>
    <div>{children}</div>
  </div>
);

// AnimatedCard
export const AnimatedCard = ({
  children,
  className = "",
}: {
  children: ReactNode;
  className?: string;
}) => (
  <motion.div
    initial={{ y: 8, opacity: 0 }}
    animate={{ y: 0, opacity: 1 }}
    className={`p-4 rounded-lg shadow ${className}`}
  >
    {children}
  </motion.div>
);

// Graph
export const Graph = ({
  data,
  xKey = "x",
  yKey = "y",
  height = 220,
}: {
  data: any[];
  xKey?: string;
  yKey?: string;
  height?: number;
}) => (
  <ResponsiveContainer width="100%" height={height}>
    <LineChart data={data}>
      <Line dataKey={yKey} />
      <CartesianGrid />
      <XAxis dataKey={xKey} />
      <YAxis />
    </LineChart>
  </ResponsiveContainer>
);

// SVGCanvas
export const SVGCanvas = ({
  width = 600,
  height = 300,
  shapes = [],
}: {
  width?: number;
  height?: number;
  shapes: {
    type: "circle" | "line" | "path";
    [key: string]: any;
  }[];
}) => (
  <svg width={width} height={height} viewBox={`0 0 ${width} ${height}`}>
    {shapes.map((s, i) => {
      if (s.type === "circle")
        return <circle key={i} cx={s.cx} cy={s.cy} r={s.r} fill={s.fill} />;
      if (s.type === "line")
        return (
          <line
            key={i}
            x1={s.x1}
            y1={s.y1}
            x2={s.x2}
            y2={s.y2}
            stroke={s.stroke}
          />
        );
      if (s.type === "path")
        return (
          <path key={i} d={s.d} fill={s.fill || "none"} stroke={s.stroke} />
        );
      return null;
    })}
  </svg>
);

// Calculator
export const Calculator = ({
  formula,
  inputs,
  onResult,
}: {
  formula: string;
  inputs: { name: string; label: string; type?: string }[];
  onResult: (result: number) => void;
}) => <CalculatorUI formula={formula} inputs={inputs} onResult={onResult} />;

// Quiz
type QuizQuestion = {
  id: number;
  question: string;
  options: string[];
  correct: string;
};

export const Quiz = ({
  questions,
  onComplete,
}: {
  questions: QuizQuestion[];
  onComplete: (score: number) => void;
}) => <QuizComponent questions={questions} onComplete={onComplete} />;

// Timeline
export const Timeline = ({
  steps,
}: {
  steps: { title: string; desc: string }[];
}) => (
  <ol>
    {steps.map((s, i) => (
      <li key={i}>
        <strong>{s.title}</strong>
        <div>{s.desc}</div>
      </li>
    ))}
  </ol>
);

// CodeBlock
export const CodeBlock = ({
  code,
  language = "tsx",
}: {
  code: string;
  language?: string;
}) => (
  <pre className="rounded bg-slate-900 text-white p-3">
    <code>{code}</code>
  </pre>
);

// Math
export const Math = ({ tex }: { tex: string }) => (
  <div dangerouslySetInnerHTML={{ __html: katex.renderToString(tex) }} />
);
</file>

<file path="lib/supabase/server.ts">
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options),
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    },
  );
}
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  experimental: {
    serverComponentsExternalPackages: ["esbuild", "vm2"],
  },
  serverExternalPackages: ["esbuild", "vm2"],
};

export default nextConfig;
</file>

<file path="lib/types.ts">
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  public: {
    Tables: {
      courses: {
        Row: {
          created_at: string
          id: number
          outline: Json | null
          status: string | null
          topic: string | null
          trace_id: string | null
          trace_url: string | null
          updated_at: string | null
          user_id: string | null
        }
        Insert: {
          created_at?: string
          id?: number
          outline?: Json | null
          status?: string | null
          topic?: string | null
          trace_id?: string | null
          trace_url?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Update: {
          created_at?: string
          id?: number
          outline?: Json | null
          status?: string | null
          topic?: string | null
          trace_id?: string | null
          trace_url?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Relationships: []
      }
      lessons: {
        Row: {
          compiled_js_url: string | null
          course_id: number | null
          created_at: string
          error: string | null
          id: number
          objective: string | null
          order: number | null
          status: string | null
          title: string | null
          trace_id: string | null
          trace_url: string | null
          updated_at: string | null
        }
        Insert: {
          compiled_js_url?: string | null
          course_id?: number | null
          created_at?: string
          error?: string | null
          id?: number
          objective?: string | null
          order?: number | null
          status?: string | null
          title?: string | null
          trace_id?: string | null
          trace_url?: string | null
          updated_at?: string | null
        }
        Update: {
          compiled_js_url?: string | null
          course_id?: number | null
          created_at?: string
          error?: string | null
          id?: number
          objective?: string | null
          order?: number | null
          status?: string | null
          title?: string | null
          trace_id?: string | null
          trace_url?: string | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "lessons_course_id_fkey"
            columns: ["course_id"]
            isOneToOne: false
            referencedRelation: "courses"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {},
  },
} as const
</file>

<file path="app/api/chat/route.ts">
import { generateCoursePlan } from "@/lib/ai/tools";
import { google } from "@ai-sdk/google";
import * as ai from "ai";
import { stepCountIs } from "ai";
import { wrapAISDK } from "langsmith/experimental/vercel";

const { streamText } = wrapAISDK(ai);

export async function POST(req: Request) {
  const { messages, userId }: { messages: ai.UIMessage[]; userId: string } =
    await req.json();
  console.log("userId: ", userId);

  const result = streamText({
    model: google("gemini-flash-latest"),
    system: `You are a helpful educational assistant that helps users create structured courses.

When a user asks to create a course or lessons, you MUST:
0. Just generate some pretext, like whatever, a bit about topic 2-3 liners are enough.
1. Call the generateCoursePlan
2. Wait for the tool result
3. Explain to the user what was created based on the tool output
4. Include the course_id from the tool result in your response

Always acknowledge the course creation and provide details about the generated lessons.`,
    messages: ai.convertToModelMessages(messages),
    tools: {
      generateCoursePlan,
    },
    stopWhen: stepCountIs(5), // Allow multiple steps for tool calling
    experimental_transform: ai.smoothStream(),
  });

  return result.toUIMessageStreamResponse();
}
</file>

<file path="inngest/functions.ts">
import { inngest } from "./client";
import { vercel } from "@ai-sdk/vercel";
import { generateText } from "@/lib/ai";
import { transformSync } from "esbuild";
import { createClient } from "@supabase/supabase-js";
import { Database } from "@/lib/types";
import { generate_svg_tool } from "@/lib/ai/tools";
import { stepCountIs } from "ai";
import { VM } from "vm2";
import {
  __lesson_writer_base_prompt,
  __lesson_writer_error_prompt,
} from "@/lib/ai/prompt";

const MAX_RETRIES = 3;

/**
 * Validates the compiled code by executing it in a safe VM environment
 * Returns { valid: true } if successful, or { valid: false, error: string } if there's a runtime error
 */
function validateCompiledCode(compiledCode: string): {
  valid: boolean;
  error?: string;
} {
  try {
    // Create a safe VM with a timeout
    const vm = new VM({
      timeout: 5000, // 5 second timeout
      sandbox: {
        // Mock React and common dependencies
        React: {
          useState: () => [null, () => {}],
          useEffect: () => {},
          useCallback: () => {},
          useMemo: () => null,
          useRef: () => ({ current: null }),
          createElement: () => ({}),
          Fragment: {},
        },
        console: {
          log: () => {},
          error: () => {},
          warn: () => {},
        },
        // Mock window object for any window references
        window: {},
        document: {},
        // Mock registry components
        Box: () => ({}),
        Text: () => ({}),
        Callout: () => ({}),
        Calculator: () => ({}),
        AnimatedCard: () => ({}),
        SVGCanvas: () => ({}),
        Math: () => ({}),
        Timeline: () => ({}),
        Quiz: () => ({}),
        CodeBlock: () => ({}),
        Graph: () => ({}),
      },
    });

    // Wrap the compiled code to catch any execution errors
    const wrappedCode = `
      ${compiledCode}

      // Check if LessonComponent is defined and is a function
      if (typeof LessonComponent === 'undefined') {
        throw new Error('LessonComponent is not defined');
      }

      if (typeof LessonComponent !== 'function') {
        throw new Error('LessonComponent is not a function');
      }

      // Try to instantiate the component to catch immediate errors
      try {
        LessonComponent({});
      } catch (e) {
        // If it's a hook error, that's okay - it means the component is structured correctly
        if (e.message && e.message.includes('hook')) {
          // This is expected - hooks can't be called outside of React
          return true;
        }
        throw e;
      }

      return true;
    `;

    const result = vm.run(wrappedCode);

    return { valid: true };
  } catch (err: any) {
    console.error("Runtime validation error:", err.message);
    return {
      valid: false,
      error: `Runtime error: ${err.message}`,
    };
  }
}

// Create a Supabase client with service role for server-side operations
function createServiceClient() {
  return createClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    },
  );
}

export const generateLesson = inngest.createFunction(
  { id: "generate_lesson" },
  { event: "lesson.generate" },

  async ({ event, step }) => {
    const { lesson_id, title, objective, course_id, previous_error, is_retry } =
      event.data;
    console.log(`[Inngest] Starting lesson generation for lesson ${lesson_id}`);
    const supabase = createServiceClient();

    let attempt = 0;
    let lastErr = "";
    let generated_code = "";

    const { error: statusError } = await supabase
      .from("lessons")
      .update({ status: "processing" })
      .eq("id", lesson_id);

    if (statusError) {
      console.error("Failed to update status to processing:", statusError);
    }

    while (attempt < MAX_RETRIES) {
      attempt++;
      console.log(
        `[Inngest] Attempt ${attempt}/${MAX_RETRIES} for lesson ${lesson_id}`,
      );

      // Build the prompt based on whether this is a retry or first attempt
      let prompt = "";

      if (attempt === 1 && is_retry && previous_error) {
        // This is a manual retry with a previous error
        prompt =
          `You are an expert React/TypeScript developer and educational content creator.

This is a RETRY attempt. The previous generation failed with the following error:
${previous_error}

Please generate a corrected version that addresses this error.` +
          __lesson_writer_base_prompt({ title, objective });
      } else if (attempt === 1) {
        // First attempt (not a retry)
        prompt =
          "You are an expert React/TypeScript developer and educational content creator." +
          __lesson_writer_base_prompt({ title, objective });
      } else {
        // Subsequent retry attempts within the same run
        prompt = __lesson_writer_error_prompt({ lastErr, generated_code });
      }

      const result = await generateText({
        model: vercel("v0-1.5-md"),
        prompt: prompt,
        temperature: 0.6,
        maxOutputTokens: 10000,
        stopWhen: stepCountIs(5), // Allow up to 5 steps for tool calls and continuation
        tools: { generate_svg: generate_svg_tool },
      });

      console.log("Generation steps:", result.steps?.length || 0);
      console.log("Tool calls made:", result.toolCalls?.length || 0);

      // Log tool results for debugging
      if (result.toolResults && result.toolResults.length > 0) {
        console.log(
          "Tool results:",
          JSON.stringify(result.toolResults, null, 2),
        );
      }

      // Extract the final text after all tool calls
      generated_code = result.text
        .replace(/```typescript\n?/g, "")
        .replace(/```tsx\n?/g, "")
        .replace(/```javascript\n?/g, "")
        .replace(/```jsx\n?/g, "")
        .replace(/```\n?/g, "")
        .trim();

      // If no component code generated, log the issue
      if (!generated_code.includes("function LessonComponent")) {
        console.error("No LessonComponent found in generated code!");
        console.error("Full response:", result.text);
        lastErr = "Model did not generate a LessonComponent function";
        continue;
      }

      // ===== NEW: Add basic syntax validation =====
      const openBraces = (generated_code.match(/{/g) || []).length;
      const closeBraces = (generated_code.match(/}/g) || []).length;
      const openParens = (generated_code.match(/\(/g) || []).length;
      const closeParens = (generated_code.match(/\)/g) || []).length;

      if (openBraces !== closeBraces) {
        lastErr = `Syntax error: Mismatched braces (${openBraces} open, ${closeBraces} close)`;
        console.warn(lastErr);
        continue;
      }

      if (openParens !== closeParens) {
        lastErr = `Syntax error: Mismatched parentheses (${openParens} open, ${closeParens} close)`;
        console.warn(lastErr);
        continue;
      }

      let compiled: string;

      try {
        console.log("compiling code \n\n");

        const result = transformSync(generated_code, {
          loader: "tsx",
          format: "esm",
        });

        console.log("compiled code : ", result.code, "\n\n");

        compiled = result.code;

        // ====== RUNTIME VALIDATION ======
        // const validation = validateCompiledCode(compiled);

        // if (!validation.valid) {
        //   lastErr = validation.error || "Runtime validation failed";
        //   console.warn("runtime validation failed", lastErr);
        //   continue;
        // }

        // console.log("runtime validation passed");

        const fileName = `${lesson_id}.js`;
        const { error: uploadError } = await supabase.storage
          .from("lessons")
          .upload(fileName, compiled, {
            contentType: "application/javascript",
            upsert: true,
          });

        if (uploadError) {
          throw new Error(`Upload error : ${uploadError.message}`);
        }

        // Fix: Get public URL from the same path where file was uploaded
        const { data: urlData } = supabase.storage
          .from("lessons")
          .getPublicUrl(fileName);

        console.log("Public URL data:", urlData);

        const { error: updateError } = await supabase
          .from("lessons")
          .update({
            compiled_js_url: urlData.publicUrl,
            status: "completed",
            error: null, // Clear any previous errors
          })
          .eq("id", lesson_id);

        if (updateError) {
          console.error(
            "Failed to update lesson with URL and status:",
            updateError,
          );
          throw new Error(`Database update error: ${updateError.message}`);
        }

        console.log(`[Inngest] Successfully completed lesson ${lesson_id}`);
        return { success: true, lesson_id };
      } catch (err: any) {
        lastErr = `Compile error: ${err.message}`;
        console.warn(lastErr);
        continue;
      }
    }

    const { error: failError } = await supabase
      .from("lessons")
      .update({ status: "failed", error: lastErr })
      .eq("id", lesson_id);

    if (failError) {
      console.error("Failed to update lesson status to failed:", failError);
    }

    console.error(
      `[Inngest] Lesson ${lesson_id} generation failed after all retries:`,
      lastErr,
    );
    return { success: false, lesson_id, error: lastErr };
  },
);
</file>

<file path="package.json">
{
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "eslint ."
  },
  "dependencies": {
    "@ai-sdk/google": "^2.0.31",
    "@ai-sdk/openai": "^2.0.65",
    "@ai-sdk/react": "^2.0.92",
    "@ai-sdk/vercel": "^1.0.28",
    "@radix-ui/react-checkbox": "^1.3.1",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-dropdown-menu": "^2.1.14",
    "@radix-ui/react-label": "^2.1.6",
    "@radix-ui/react-slot": "^1.2.2",
    "@supabase/ssr": "latest",
    "@supabase/supabase-js": "latest",
    "ai": "^5.0.92",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "desmos-react": "^1.2.0",
    "dotenv": "^17.2.3",
    "esbuild": "^0.27.0",
    "framer-motion": "^12.23.24",
    "inngest": "^3.45.1",
    "katex": "^0.16.25",
    "langsmith": "^0.3.79",
    "lucide-react": "^0.511.0",
    "next": "latest",
    "next-themes": "^0.4.6",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-markdown": "^10.1.0",
    "recharts": "^3.4.1",
    "remark-gfm": "^4.0.1",
    "tailwind-merge": "^3.3.0",
    "uuid": "^13.0.0",
    "vm2": "^3.10.0",
    "zod": "^4.1.12"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.20",
    "eslint": "^9",
    "eslint-config-next": "15.3.1",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5"
  }
}
</file>

<file path="app/page.tsx">
"use client";

import { useChat } from "@ai-sdk/react";
import { useState, useEffect, useRef } from "react";
import { DefaultChatTransport } from "ai";
import { useUser } from "./hooks/useUser";
import {
  loadMessagesFromStorage,
  clearChatHistory,
} from "./hooks/useChatPersistence";
import LessonCard from "@/components/ui/LessonDisp";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import { Input } from "@/components/ui/input";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import { Button } from "@/components/ui/button";
import { ChevronsUpDown } from "lucide-react";
const CHAT_STORAGE_KEY = "ai-course-chat-messages";
const CHAT_VERSION = "1";

export default function Page() {
  const [input, setInput] = useState("");
  const [mounted, setMounted] = useState(false);

  const [isOpen, setIsOpen] = useState(false);
  const userId = useUser();
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Load messages synchronously on client
  const getInitialMessages = () => {
    if (typeof window === "undefined") return [];
    return loadMessagesFromStorage();
  };

  const { messages, sendMessage, setMessages } = useChat({
    transport: new DefaultChatTransport({
      body: { userId },
    }),
    messages: getInitialMessages(),
  });

  // Mark as mounted and restore messages
  useEffect(() => {
    const savedMessages = loadMessagesFromStorage();
    if (savedMessages.length > 0) {
      console.log("Restoring messages:", savedMessages);
      setMessages(savedMessages);
    }
    setMounted(true);
  }, [setMessages]);

  // Save messages to localStorage whenever they change
  useEffect(() => {
    if (!mounted || messages.length === 0) return;

    try {
      const stored = {
        version: CHAT_VERSION,
        messages,
        timestamp: Date.now(),
      };
      localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(stored));
      console.log("Saved", messages.length, "messages to localStorage");
    } catch (error) {
      console.error("Failed to save chat messages:", error);
    }
  }, [messages, mounted]);

  // Auto-scroll to bottom when new messages are added
  useEffect(() => {
    if (messages.length > 0) {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }
  }, [messages]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim()) return;
    sendMessage({ text: input });
    setInput("");
  };

  const handleClearChat = () => {
    if (confirm("Are you sure you want to clear the chat history?")) {
      clearChatHistory();
      setMessages([]);
    }
  };

  return (
    <div className="flex flex-col h-screen bg-gray-50 dark:bg-[#0a0a0a]">
      <div className="max-w-4xl mx-auto w-full flex flex-col h-full">
        {/* Header */}
        <div className="flex items-center justify-between p-6 pb-4">
          <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
            AI Course Generator
          </h1>

          {messages.length > 0 && (
            <button
              onClick={handleClearChat}
              className="px-4 py-2 text-sm text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium border border-red-300 dark:border-red-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
            >
              Clear Chat
            </button>
          )}
        </div>

        {/* Messages - Scrollable area */}
        <div className="flex-1 overflow-y-auto px-6 pb-4">
          <div className="space-y-4">
            {messages.length === 0 && (
              <div className="text-center py-12">
                <div className="text-gray-400 dark:text-gray-600 mb-4">
                  <svg
                    className="w-16 h-16 mx-auto mb-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={1.5}
                      d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                    />
                  </svg>
                </div>
                <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">
                  No messages yet
                </h3>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Start by describing the course you'd like to create
                </p>
              </div>
            )}

            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.role === "user" ? "justify-end" : "justify-start"}`}
              >
                <div
                  key={message.id}
                  className={`p-2 rounded-2xl ${
                    message.role === "user" ? "bg-[#1f1f1f]" : ""
                  }`}
                >
                  <div className="text-gray-800 dark:text-gray-200 leading-relaxed tracking-wide">
                    {message.parts?.map((part, index) => {
                      // Text content
                      if (part.type === "text") {
                        return (
                          <ReactMarkdown
                            key={index}
                            remarkPlugins={[remarkGfm]}
                          >
                            {part.text}
                          </ReactMarkdown>
                        );
                      }

                      // Course generation tool
                      if (part.type === "tool-generateCoursePlan") {
                        switch (part.state) {
                          case "input-available":
                            return (
                              <div
                                key={index}
                                className="flex items-center gap-2 text-blue-600 dark:text-blue-400"
                              >
                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                Generating course plan...
                              </div>
                            );
                          case "output-available":
                            return (
                              <CoursePlanDisplay
                                key={index}
                                output={part.output}
                              />
                            );
                          case "output-error":
                            return (
                              <div
                                key={index}
                                className="text-red-600 dark:text-red-400"
                              >
                                Error: {part.errorText}
                              </div>
                            );
                          default:
                            return null;
                        }
                      }

                      return null;
                    })}
                  </div>
                </div>
              </div>
            ))}
            <div ref={messagesEndRef} />
          </div>
        </div>

        {/* Fixed Input Form at bottom */}
        <div className="border-gray-200 dark:border-gray-700 bg-transparent p-6">
          <form
            onSubmit={handleSubmit}
            className="flex flex-row gap-2 bg-[#121212] items-center rounded-md p-2 border border-border h-15 min-h-15"
          >
            <Input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder='Try: "Create a course on Python with 5 lessons"'
              className="flex-1 px-4 py-3 focus:ring-0 border-0 text-gray-900 dark:text-white focus:border-0 focus-visible:ring-0 shadow-none"
            />
            <button
              type="submit"
              disabled={!input.trim()}
              className="p-1 pl-1.5 aspect-square flex items-center justify-center bg-white disabled:border disabled:border-border hover:bg-blue-700 disabled:bg-transparent disabled:cursor-not-allowed font-medium rounded-lg transition-colors scale-75"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="30"
                height="32"
                viewBox="0 0 15 16"
              >
                <path
                  fill={`${!input.trim() ? "#454545" : "#000000"}`}
                  d="M12.49 7.14L3.44 2.27c-.76-.41-1.64.3-1.4 1.13l1.24 4.34q.075.27 0 .54l-1.24 4.34c-.24.83.64 1.54 1.4 1.13l9.05-4.87a.98.98 0 0 0 0-1.72Z"
                />
              </svg>{" "}
            </button>
          </form>

          {messages.length > 0 && (
            <div className="mb-3 text-center">
              <p className="text-xs text-gray-500 dark:text-gray-400">
                 Chat history is saved automatically
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Component to display course plan
function CoursePlanDisplay({ output }: { output: any }) {
  const { course_plan, course_id, success, lesson_ids } = output;
  const [isOpen, setIsOpen] = useState(true);
  if (!success || !course_plan) {
    return (
      <div className="text-red-600 dark:text-red-400">
        Failed to generate course plan
      </div>
    );
  }

  return (
    <Collapsible
      open={isOpen}
      onOpenChange={setIsOpen}
      className="flex flex-col gap-2"
    >
      <div className="mt-4 p-4 dark:bg-zinc-900 border border-border rounded-lg mb-4 flex flex-row gap-2">
        <CollapsibleTrigger asChild>
          <Button variant="ghost" size="icon" className="size-8">
            <ChevronsUpDown />
            <span className="sr-only">Toggle</span>
          </Button>
        </CollapsibleTrigger>
        <div>
          <h3 className="text-sm leading-relaxed mb-2 text-gray-900 dark:text-white">
            {course_plan.title}
          </h3>
          <CollapsibleContent className="flex flex-col gap-2">
            <div className="space-y-3">
              {course_plan.lessons.map((lesson: any, idx: number) => (
                <LessonCard
                  key={idx}
                  lesson={lesson}
                  lessonId={lesson_ids?.[idx]}
                  lessonNumber={idx + 1}
                />
              ))}
            </div>
          </CollapsibleContent>
        </div>
      </div>
    </Collapsible>
  );
}
</file>

<file path="lib/ai/tools.ts">
import z from "zod";
import { tool } from "ai";
import * as ai from "ai";
import { google } from "@ai-sdk/google";
import { wrapAISDK } from "langsmith/experimental/vercel";
import { createClient } from "@supabase/supabase-js";
import { inngest } from "@/inngest/client";
import { Database } from "@/lib/types";

const { generateObject } = wrapAISDK(ai);

function createServiceClient() {
  return createClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    },
  );
}

export const generateCoursePlan = tool({
  name: "generate_course_plan",
  description: "Break a topic into multiple structured lessons",
  inputSchema: z.object({
    outline: z
      .string()
      .describe("The outline of the course provided by the user"),
    lesson_count: z.number().describe("Number of lessons to generate"),
    userId: z.string().describe("The ID of the user creating the course"),
  }),
  execute: async function ({ outline, lesson_count, userId }) {
    const supabase = createServiceClient();
    console.log("Generating course plan for:", {
      outline,
      lesson_count,
      userId,
    });

    const { object } = await generateObject({
      model: google("gemini-flash-latest"),
      schema: z.object({
        title: z
          .string()
          .describe(
            "40-50 Words title for the course based on provided outline",
          ),
        lessons: z.array(
          z.object({
            title: z.string().describe("The title of the topic to generate"),
            objective: z.string().describe("Learning objective of the lesson"),
          }),
        ),
      }),
      prompt: `Create a course breakdown for the following outline:

"${outline}"

Generate exactly ${lesson_count} lessons that cover this topic comprehensively.
Each lesson should have a clear title and specific learning objective.

Course Outline: ${outline}
Number of Lessons: ${lesson_count}

Generate the course structure now.`,
    });

    console.log("Generated course plan:", JSON.stringify(object, null, 2));

    // Insert into Supabase
    const { data: data, error: error } = await supabase
      .from("courses")
      .insert({
        title: object.title,
        outline: outline,
        user_id: userId,
      })
      .select()
      .single();

    if (error) {
      console.error("Error inserting course:", error);
      throw new Error(`Failed to store course: ${error.message}`);
    }

    const lessonInserts: Database["public"]["Tables"]["lessons"]["Insert"][] =
      object.lessons.map((lesson, index) => ({
        course_id: data.id,
        title: lesson.title,
        objective: lesson.objective,
        status: "pending",
      }));

    const { data: lessons, error: lessonsError } = await supabase
      .from("lessons")
      .insert(lessonInserts)
      .select();

    if (lessonsError) {
      throw new Error(`Failed to store lessons : ${lessonsError.message}`);
    }

    console.log(`Created ${lessons.length} lesson entries`);

    const eventPromises = lessons.map((lesson) =>
      inngest.send({
        name: "lesson.generate",
        data: {
          lesson_id: lesson.id,
          title: lesson.title,
          objective: lesson.objective,
          course_id: data.id,
        },
      }),
    );

    await Promise.all(eventPromises);
    console.log(`Triggered ${eventPromises.length} Inngest events`);

    return {
      course_plan: object,
      course_id: data?.id,
      lesson_ids: lessons.map((l) => l.id),
      lesson_count: lessons.length,
      success: true,
      message: `Created Course ${object.title} with ${lessons.length} lessons`,
    };
  },
});

export const generate_svg_tool = tool({
  name: "generate_svg",
  description: "Generate a clean educational SVG diagram",
  inputSchema: z.object({
    prompt: z
      .string()
      .describe(
        "Detailed instructions describing what the diagram should show",
      ),
  }),
  execute: async ({ prompt }) => {
    // INTERNAL strict SVG generation prompt
    const svgDirective = `
You are an SVG diagram generator.

Your ONLY task is to output a SINGLE <svg> element that contains the diagram.

HARD REQUIREMENTS:
- Output ONLY valid inline SVG markup.
- The ENTIRE response MUST be exactly: <svg> ... </svg>
- NO backticks, NO markdown, NO explanations, NO comments.
- Black 2px strokes only.
- No gradients, filters, clipPaths, masks, CSS, <defs>, external references.
- Use simple primitives only: <line>, <circle>, <rect>, <path>, <polygon>.
- Center the diagram and make it readable.
- Use explicit width="600" height="300" and a matching viewBox.

User diagram request:
${prompt}
    `.trim();

    const { object } = await generateObject({
      model: google("gemini-2.5-flash"),
      schema: z.object({
        svg: z
          .string()
          .describe("The final SVG diagram. Must be a single <svg> element."),
      }),
      prompt: svgDirective,
    });

    return { svg: object.svg };
  },
});
</file>

</files>
